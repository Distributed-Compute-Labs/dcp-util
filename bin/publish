#!/usr/bin/env node
/**
 *  @file       publish
 *              Utility for deploying DCP Modules from package description files.
 *
 *              A package description file is a JSON file with the following structure:
 *              {
 *                name: string,
 *                version: semver string,
 *                files: {
 *                  [localPathToFile: string]: [destinationFilename: string]
 *                }
 *              }
 *
 *  @author     Ryan Rossiter, ryan@kingsds.network
 *  @date       July 2020
 */

const process = require('process');

require('dcp-client').initSync();
const { base, getIdentityKeystore } = require('dcp/dcp-cli');
const { publish } = require('dcp/publish');

/**
 *
 */
async function main() {
  // Process CLI
  const { packageDescription } = base(
    'Utility to publish a new/updated DCP package',
  ).command(['$0 packageDescription', 'publish'], '', (yargs) => {
    yargs.positional('packageDescription', {
      describe: 'Path to the package description file.',
    });
  }).argv;

  const idKs = await getIdentityKeystore();
  const result = await publish(packageDescription, idKs);

  console.log(
    'Successfully published package:\n',
    JSON.stringify(result, null, 2),
  );
}

main()
  .catch((e) => {
    console.error('Failed to execute command:');
    console.error(e);
    process.exitCode = 1;
  })
  .finally(() => setImmediate(process.exit));
